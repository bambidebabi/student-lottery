<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - ä¸¤é¡µç‰ˆ</title>
    <style>
        /* 1. å…¨å±€æ ·å¼å’ŒèƒŒæ™¯ */
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e6ed 100%);
            margin: 0;
        }

        /* 2. ä¸»å®¹å™¨ */
        .container {
            background-color: #ffffff;
            padding: 40px 50px;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 5px solid #FFD700;
        }

        /* 3. æ ‡é¢˜ */
        h1 {
            color: #E91E63;
            margin-bottom: 10px;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 4. è®¾ç½®é¡µé¢é€šç”¨æ ·å¼ */
        .setup-section {
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #FF9800;
            border-radius: 10px;
            background-color: #fffaf0;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .action-button {
            background-color: #FF9800;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .action-button:hover {
            background-color: #F57C00;
        }

        /* 5. æŠ½å¥–ä¿¡æ¯åŒº */
        .user-info {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 1px dashed #ccc;
        }
        
        .user-info strong {
            color: #E91E63;
        }

        .rule {
            background-color: #ffe0b2;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
            color: #FF5722;
        }

        /* 6. ç§¯åˆ†æ˜¾ç¤º */
        #points-display {
            font-size: 3.5em;
            color: #4CAF50;
            font-weight: 900;
            margin: 10px 0 25px 0;
            letter-spacing: 2px;
        }

        /* 7. æŒ‰é’®æ ·å¼ */
        #draw-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 18px 30px;
            font-size: 1.4em;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s;
            width: 100%;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            font-weight: bold;
            margin-bottom: 20px;
        }

        #draw-button:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* 8. æ»šåŠ¨æ˜¾ç¤ºåŒºå®¹å™¨ */
        #lottery-machine {
            position: relative;
            width: 100%;
            height: 80px; 
            overflow: hidden;
            border: 4px solid #FF5722;
            border-radius: 12px;
            background-color: #fff8e1;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* 9. æ»šåŠ¨æ¡ç›®åˆ—è¡¨ */
        #prize-roller {
            position: absolute;
            top: 0;
            width: 100%;
            transition: transform 0s ease-out; 
        }

        /* 9.1 å¥–å“é¡¹ */
        .prize-item {
            height: 80px; 
            display: flex;
            align-items: center; 
            justify-content: center; 

            font-size: 1.6em;
            font-weight: bolder;
            color: #333;
            text-align: center;
            border-bottom: 1px dashed #ccc;
            box-sizing: border-box; 
        }
        .prize-item:last-child {
            border-bottom: none;
        }

        /* 11. ç»“æœæ–‡æœ¬æ˜¾ç¤ºåŒº */
        .result-text {
            margin-top: 15px;
            padding: 10px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 8px;
        }
        .win-text {
            color: #4CAF50;
            background-color: #e8f5e9;
        }

        /* 12. åº•éƒ¨åŠŸèƒ½æŒ‰é’® */
        #set-next-user-button, #back-to-setup-button, #clear-all-button {
            margin-top: 20px;
            padding: 10px 20px !important;
            font-size: 1em !important;
        }

        #set-next-user-button {
            background-color: #607D8B !important; 
        }
        
        #clear-all-button {
            background-color: #F44336 !important;
        }
        
        #back-to-setup-button {
            background-color: #3F51B5 !important;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="prize-setup-page">
            <h1>ğŸ å¥–å“ä¸æ¦‚ç‡è®¾ç½® ğŸ</h1>
            <div class="setup-section">
                <h2>1. å®šä¹‰å¥–å“ä¸æ¦‚ç‡ (æ€»å’Œéœ€ä¸º 100%)</h2>
                <div class="input-group">
                    <label for="input-prizes">æ ¼å¼: åç§°:æ¦‚ç‡(%)ï¼Œæ¯è¡Œä¸€ä¸ª</label>
                    <textarea id="input-prizes" rows="10" placeholder="ä¾‹å¦‚ï¼š
å“ªå’å¡ç‰‡:15
æ©¡çš®:15
ç²˜è´´:15
ç¬”:30
å¤§ç¬”è®°:10
èµ„æ–™å¤¹:7
å¡é€šæœ¬:5
æŒ‚ä»¶:2
èƒ¸é’ˆ:1"></textarea>
                </div>
                <div id="prob-error" style="color: red; font-weight: bold; margin-bottom: 10px;"></div>
            </div>

            <div class="setup-section">
                <h2>2. è®¾ç½®å­¦ç”Ÿåˆå§‹ä¿¡æ¯</h2>
                <div class="input-group">
                    <label for="input-name">å­¦ç”Ÿå§“åï¼š</label>
                    <input type="text" id="input-name" placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“å">
                </div>
                <div class="input-group">
                    <label for="input-points">åˆå§‹ç§¯åˆ†ï¼š</label>
                    <input type="number" id="input-points" value="100" min="0" placeholder="è¯·è¾“å…¥åˆå§‹ç§¯åˆ†">
                </div>
                <button class="action-button" onclick="confirmPrizesAndStart()">ç¡®è®¤è®¾ç½®å¹¶è¿›å…¥æŠ½å¥–é¡µé¢</button>
                <button id="clear-all-button" onclick="clearAllPrizes()" class="action-button" style="background-color: #F44336; margin-top: 15px;">
                    ğŸš¨ æ¸…ç©ºæ‰€æœ‰ç§¯åˆ†å¹¶é‡ç½®
                </button>
            </div>
        </div>

        <div id="lottery-page" style="display:none;">
            <h1>ğŸ† ç§¯åˆ†å¹¸è¿æŠ½å¥– ğŸ†</h1>

            <div class="user-info">
                å½“å‰æŠ½å¥–ç”¨æˆ·ï¼š<strong id="current-name"></strong>
            </div>
            
            <div class="user-info">
                æ‚¨çš„å½“å‰ç§¯åˆ†ï¼š
                <div id="points-display"></div>
            </div>

            <div class="info">
                <div class="rule">
                    æŠ½å¥–è§„åˆ™ï¼š**10 ç§¯åˆ† = 1 æ¬¡æœºä¼š**
                </div>
                <div class="rule" style="margin-top: 10px;">
                    å½“å‰å…±æœ‰ <strong id="prize-count">0</strong> ç§å¥–å“å‚ä¸æŠ½å¥–
                </div>
            </div>
            
            <button id="draw-button" onclick="startDraw()">
                æ¶ˆè€— 10 ç§¯åˆ†ï¼Œå¼€å§‹æŠ½å¥–ï¼
            </button>

            <div id="lottery-machine">
                <div id="prize-roller">
                    </div>
                <div id="indicator"></div> 
            </div>

            <div class="result-text win-text" id="result-text-display">
                ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–ï¼
            </div>
            
            <button id="set-next-user-button" onclick="promptSetupUser()"></button>
            <button id="back-to-setup-button" class="action-button" onclick="showPrizeSetup()">è¿”å›å¥–å“è®¾ç½®</button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let userName = "";
        let userPoints = 0;
        let activePrizes = []; // æ–°å¢ï¼šå­˜å‚¨ç”¨æˆ·å®šä¹‰çš„å¥–å“å’Œç´¯ç§¯æ¦‚ç‡
        const COST_PER_DRAW = 10;
        const PRIZE_HEIGHT = 80; 
        const HALF_PRIZE_HEIGHT = 0; // ä¿æŒç²¾ç¡®å¯¹é½ä¿®å¤
        const REPETITIONS = 6; // å¥–å“é‡å¤æ¬¡æ•°

        // DOM å…ƒç´ å¼•ç”¨
        const prizeSetupPage = document.getElementById('prize-setup-page');
        const lotteryPage = document.getElementById('lottery-page');
        const pointsDisplay = document.getElementById('points-display');
        const currentNameDisplay = document.getElementById('current-name');
        const resultTextDisplay = document.getElementById('result-text-display');
        const drawButton = document.getElementById('draw-button');
        const inputName = document.getElementById('input-name');
        const inputPoints = document.getElementById('input-points');
        const inputPrizes = document.getElementById('input-prizes');
        const probErrorDisplay = document.getElementById('prob-error');
        const prizeRoller = document.getElementById('prize-roller');
        const prizeCountDisplay = document.getElementById('prize-count');
        const setNextUserButton = document.getElementById('set-next-user-button');


        /**
         * è§£æç”¨æˆ·è¾“å…¥çš„å¥–å“å’Œæ¦‚ç‡ï¼Œå¹¶è®¡ç®—ç´¯ç§¯æ¦‚ç‡ã€‚
         */
        function parsePrizes() {
            const lines = inputPrizes.value.trim().split('\n').filter(line => line.trim() !== '');
            let totalProb = 0;
            let cumulativeProb = 0;
            const newPrizes = [];

            for (const line of lines) {
                const parts = line.split(':');
                if (parts.length !== 2) {
                    probErrorDisplay.textContent = `æ ¼å¼é”™è¯¯: "${line}"ã€‚åº”ä¸º "åç§°:æ¦‚ç‡(%)"`;
                    return null;
                }

                const name = parts[0].trim();
                const probPercent = parseFloat(parts[1].trim());

                if (isNaN(probPercent) || probPercent <= 0) {
                    probErrorDisplay.textContent = `æ¦‚ç‡é”™è¯¯: "${line}"ã€‚æ¦‚ç‡å¿…é¡»æ˜¯æ­£æ•°ã€‚`;
                    return null;
                }
                
                // å°†ç™¾åˆ†æ¯”è½¬æ¢ä¸ºä¸‡åˆ†æ¯” (ä¾‹å¦‚ 15% -> 1500)
                const probUnit = Math.round(probPercent * 100); 
                
                cumulativeProb += probUnit;
                totalProb += probPercent;

                newPrizes.push({
                    name: name,
                    threshold: cumulativeProb // å­˜å‚¨ç´¯ç§¯é˜ˆå€¼
                });
            }

            // æ£€æŸ¥æ€»æ¦‚ç‡æ˜¯å¦ä¸º 100% (å®¹å¿ 0.01% çš„æµ®ç‚¹è¯¯å·®)
            if (Math.abs(totalProb - 100) > 0.01) {
                probErrorDisplay.textContent = `æ¦‚ç‡æ€»å’Œå¿…é¡»ä¸º 100%ã€‚å½“å‰æ€»å’Œ: ${totalProb.toFixed(2)}%ã€‚`;
                return null;
            }
            
            if (newPrizes.length === 0) {
                 probErrorDisplay.textContent = `è¯·è®¾ç½®è‡³å°‘ä¸€ä¸ªå¥–å“ã€‚`;
                 return null;
            }

            probErrorDisplay.textContent = `âœ… æ¦‚ç‡æ€»å’Œæ­£ç¡® (${totalProb.toFixed(2)}%)ï¼Œå…± ${newPrizes.length} é¡¹å¥–å“ã€‚`;
            return newPrizes;
        }

        /**
         * ç¡®è®¤å¥–å“è®¾ç½®ï¼Œå¹¶åˆ‡æ¢åˆ°æŠ½å¥–é¡µé¢ã€‚
         */
        function confirmPrizesAndStart() {
            const prizesData = parsePrizes();

            if (prizesData === null) {
                return; // è§£æå¤±è´¥ï¼Œåœç•™åœ¨è®¾ç½®é¡µ
            }
            
            activePrizes = prizesData;

            // æå–ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·ä¿¡æ¯
            const name = inputName.value.trim();
            const points = parseInt(inputPoints.value);

            if (!name) {
                alert("è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼");
                return;
            }
            if (isNaN(points) || points < 0) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆå§‹ç§¯åˆ†æ•°é‡ï¼");
                return;
            }

            userName = name;
            userPoints = points;
            
            // åˆ‡æ¢åˆ°æŠ½å¥–é¡µé¢ï¼Œå¹¶åˆå§‹åŒ–æ»šè½®
            showLotteryPage();
        }

        /**
         * åˆ‡æ¢åˆ°å¥–å“è®¾ç½®é¡µé¢ (ç¬¬ä¸€é¡µ)
         */
        function showPrizeSetup() {
            lotteryPage.style.display = 'none';
            prizeSetupPage.style.display = 'block';
            
            // æ¢å¤ç”¨æˆ·ç§¯åˆ†åˆ°è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿è®¾ç½®ä¸‹ä¸€ä½æ—¶ç»§ç»­
            inputPoints.value = userPoints; 
        }

        /**
         * åˆ‡æ¢åˆ°æŠ½å¥–é¡µé¢ (ç¬¬äºŒé¡µ)
         */
        function showLotteryPage() {
             // 1. åˆ‡æ¢ç•Œé¢
            prizeSetupPage.style.display = 'none';
            lotteryPage.style.display = 'block';

            // 2. æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            // 3. å¡«å……æ»šè½®ï¼Œä½¿ç”¨æ–°çš„ activePrizes
            populateRoller();
            
            // 4. ç¡®ä¿æ»šè½®åˆå§‹ä½ç½®æ­£ç¡®ï¼ˆç©ºç™½ï¼‰
            const prizesPerSet = activePrizes.length;
            const initialPosition = -(prizesPerSet * PRIZE_HEIGHT);
            prizeRoller.style.transition = 'none';
            prizeRoller.style.transform = `translateY(${initialPosition}px)`;
            
            // 5. æ›´æ–°å¥–å“æ•°é‡æ˜¾ç¤º
            prizeCountDisplay.textContent = prizesPerSet;
            
            // 6. é‡ç½®ç»“æœæ–‡æœ¬
            resultTextDisplay.textContent = "ç‚¹å‡»æŒ‰é’®å¼€å§‹æŠ½å¥–ï¼";
            resultTextDisplay.className = 'result-text win-text'; 

            // 7. æ¸…ç©ºè®¾ç½®è¾“å…¥æ¡†ï¼Œå‡†å¤‡ä¸‹ä¸€ä½ç”¨æˆ·è¾“å…¥
            inputName.value = "";
            inputPoints.value = "0";
        }
        
        /**
         * å¡«å……æ»šåŠ¨åŒºåŸŸçš„å¥–å“åˆ—è¡¨
         */
        function populateRoller() {
            if (activePrizes.length === 0) return;
            
            const prizeNames = activePrizes.map(p => p.name);
            prizeRoller.innerHTML = '';

            for (let i = 0; i < REPETITIONS; i++) {
                prizeNames.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'prize-item';
                    item.textContent = name;
                    prizeRoller.appendChild(item);
                });
            }
        }
        
        /**
         * æ›´æ–°é¡µé¢ä¸Šçš„ç§¯åˆ†å’Œå§“åæ˜¾ç¤º
         */
        function updateDisplay() {
            currentNameDisplay.textContent = userName;
            pointsDisplay.textContent = userPoints;
            
            drawButton.disabled = userPoints < COST_PER_DRAW;
            if (userPoints < COST_PER_DRAW) {
                drawButton.textContent = "ç§¯åˆ†ä¸è¶³ 10ï¼Œæ— æ³•æŠ½å¥–";
            } else {
                drawButton.textContent = `æ¶ˆè€— ${COST_PER_DRAW} ç§¯åˆ†ï¼Œå¼€å§‹æŠ½å¥–ï¼`;
            }
            
            setNextUserButton.textContent = `è®¾ç½®ä¸‹ä¸€ä½å­¦ç”Ÿ (${userName} çš„ ${userPoints} ç§¯åˆ†å·²ä¿ç•™)`;
            
            // å¦‚æœåœ¨è®¾ç½®é¡µï¼Œåˆ™æ›´æ–°è®¾ç½®é¡µçš„ç§¯åˆ†è¾“å…¥æ¡†
            if (prizeSetupPage.style.display !== 'none') {
                inputPoints.value = userPoints;
            }
        }

        /**
         * æ ¹æ®éšæœºæ•°è¿”å›å¥–å“å¯¹è±¡
         */
        function getPrize(randomNumber) {
            // randomNumber èŒƒå›´æ˜¯ 1 åˆ° 10000
            for (const prize of activePrizes) {
                if (randomNumber <= prize.threshold) {
                    return prize;
                }
            }
            return {name: "ç³»ç»Ÿé”™è¯¯", threshold: 10000}; 
        }

        /**
         * å¼€å§‹æŠ½å¥–æµç¨‹
         */
        function startDraw() {
            if (userPoints < COST_PER_DRAW) {
                alert("ç§¯åˆ†ä¸è¶³ï¼Œè¯·è·å–æ›´å¤šç§¯åˆ†ã€‚");
                return;
            }

            drawButton.disabled = true;

            // 1. æ‰£é™¤ç§¯åˆ†
            userPoints -= COST_PER_DRAW;
            updateDisplay();

            // 2. ç¡®å®šä¸­å¥–ç»“æœå’Œå…¶åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®
            // éšæœºæ•°èŒƒå›´ 1-10000
            const randomNumber = Math.floor(Math.random() * 10000) + 1; 
            const finalPrize = getPrize(randomNumber);
            const prizeNames = activePrizes.map(p => p.name);
            const prizeIndex = prizeNames.findIndex(name => name === finalPrize.name);

            // 3. è®¡ç®—æ»šåŠ¨ç›®æ ‡ä½ç½®
            const prizesPerSet = prizeNames.length; 
            const targetSet = REPETITIONS - 1; // ç›®æ ‡ç»„æ•° (å€’æ•°ç¬¬äºŒç»„)
            const targetIndexInRoller = (prizesPerSet * targetSet) + prizeIndex; 
            
            // æœ€ç»ˆå®šä½ï¼š- (ç›®æ ‡ç´¢å¼• * 80 + 0)
            const targetPosition = -((targetIndexInRoller * PRIZE_HEIGHT) + HALF_PRIZE_HEIGHT);

            // 4. å¼€å§‹æ»šåŠ¨åŠ¨ç”»
            
            // ç¬é—´å®šä½åˆ°ç¬¬äºŒç»„çš„æŸä¸ªéšæœºå¥–å“ä½ç½®
            const jumpIndex = prizesPerSet * 2 + Math.floor(Math.random() * prizesPerSet);
            const jumpPosition = -((jumpIndex * PRIZE_HEIGHT) + HALF_PRIZE_HEIGHT); 
            
            prizeRoller.style.transition = 'none';
            prizeRoller.style.transform = `translateY(${jumpPosition}px)`;

            // å»¶è¿Ÿåå¼€å§‹å¹³ç¨³æ»šåŠ¨åˆ°æœ€ç»ˆä½ç½®
            setTimeout(() => {
                prizeRoller.style.transition = 'transform 3.5s cubic-bezier(0.2, 0.8, 0.4, 1)'; 
                prizeRoller.style.transform = `translateY(${targetPosition}px)`;
            }, 50);


            // 5. åŠ¨ç”»ç»“æŸåæ˜¾ç¤ºæœ€ç»ˆç»“æœ
            setTimeout(() => {
                resultTextDisplay.textContent = `æ­å–œ ${userName} æŠ½ä¸­ï¼š${finalPrize.name}ï¼`;
                resultTextDisplay.className = 'result-text win-text'; 
                
                // é‡æ–°å¯ç”¨æŒ‰é’®
                drawButton.disabled = (userPoints < COST_PER_DRAW);
            }, 3550); // åŠ¨ç”»æ—¶é—´ 3.5 ç§’åæ˜¾ç¤ºç»“æœ
        }

        /**
         * è·³è½¬å›è®¾ç½®é¡µï¼Œç”¨äºè®¾ç½®ä¸‹ä¸€ä½å­¦ç”Ÿ
         */
        function promptSetupUser() {
             // ä»…åˆ‡æ¢å›è®¾ç½®é¡µï¼Œä¿ç•™å½“å‰ç§¯åˆ†
             showPrizeSetup();
        }

        /**
         * æ¸…ç©ºæ‰€æœ‰ç§¯åˆ†å¹¶é‡ç½®ä¸ºè®¾ç½®ç•Œé¢
         */
        function clearAllPrizes() {
            if (confirm("ğŸš¨ è­¦å‘Šï¼šè¿™å°†é‡ç½®å¹¶æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†å’Œå¥–å“è®¾ç½®ã€‚ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ")) {
                userName = "";
                userPoints = 0;
                activePrizes = [];
                inputPrizes.value = ""; // æ¸…ç©ºå¥–å“è®¾ç½®
                probErrorDisplay.textContent = "";
                
                showPrizeSetup();
                inputPoints.value = "0"; 
                
                alert("å·²æˆåŠŸæ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿã€‚");
            }
        }


        /**
         * åˆå§‹åŒ–å‡½æ•°
         */
        function init() {
            // é»˜è®¤å¥–å“è®¾ç½®ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼Œå¦‚æœç”¨æˆ·ä¸ä¿®æ”¹åˆ™ä½¿ç”¨æ­¤é»˜è®¤å€¼ï¼‰
            inputPrizes.value = 
`å“ªå’å¡ç‰‡:15
æ©¡çš®:15
ç²˜è´´:15
ç¬”:30
å¤§ç¬”è®°:10
èµ„æ–™å¤¹:7
å¡é€šæœ¬:5
æŒ‚ä»¶:2
èƒ¸é’ˆ:1`;
            
            // é»˜è®¤æ˜¾ç¤ºè®¾ç½®é¡µé¢
            lotteryPage.style.display = 'none';
            prizeSetupPage.style.display = 'block';
            
            // ç¡®ä¿é¡µé¢åŠ è½½æ—¶ï¼Œå¥–å“ç»“æ„å·²è¢«è§£æä¸€æ¬¡ï¼ˆå¦‚æœç”¨æˆ·æ²¡æ”¹åŠ¨ï¼‰
            parsePrizes();
        }
        
        init();
    </script>

</body>
</html>
